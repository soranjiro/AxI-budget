# AxI-budget PWA 設計書

---

## 1. プロジェクト概要

### 1.1 プロダクト名
**AxI-budget (アクシィ・バジェット)** - "流れ"を捉える、次世代スマート家計簿

### 1.2 プロダクト概要
全てのお金の流れを記録しつつ、実際の支出のみを家計管理に反映する革新的なPWA（プログレッシブウェブアプリ）家計簿アプリ。立て替え精算やグループ旅行の割り勘機能も内蔵し、ユーザー登録不要で利用開始できます。

### 1.3 主要機能
*   全トランザクション（取引）の記録・管理
*   実支出（家計に影響のある支出）ベースの家計管理
*   立て替え精算機能
*   グループ精算機能（ユーザー登録不要）
*   予算管理
*   リアルタイムでの精算計算

---

## 2. 開発哲学

本プロジェクトは、高品質で保守性の高いソフトウェアを効率的に開発するため、以下の3つの開発手法を中核的な哲学として採用します。

### 2.1 テスト駆動開発 (TDD - Test-Driven Development)
*   **原則:** ビジネスロジックを実装する前に、そのロジックを検証するためのテストコードを先に書きます。
*   **プロセス:** Red（失敗するテストを書く）→ Green（テストをパスする最小限のコードを書く）→ Refactor（コードをクリーンにする）のサイクルを徹底します。
*   **対象:** 特にバックエンドのドメインロジック、フロントエンドの複雑な状態遷移や計算処理に適用します。

### 2.2 ドメイン駆動設計 (DDD - Domain-Driven Design)
*   **原則:** ビジネスの中心概念（ドメイン）をソフトウェアのモデルの核心に据えます。
*   **実践:**
    *   **ユビキタス言語:** 開発者と企画者が共通の言葉（例: `Transaction` (取引), `Settlement` (精算), `Flow` (お金の移動), `Real` (実支出)）で対話し、それを直接コード（型定義、クラス名、変数名）に反映させます。
    *   **境界づけられたコンテキスト:** 「個人家計簿」「グループ精算」といった明確な境界で責務を分離し、モデルの複雑性を管理します。
    *   **エンティティと値オブジェクト:** IDで識別される`Transaction`（エンティティ）と、属性自体が重要な`Amount`（値オブジェクト）などを明確に区別してモデル化します。

### 2.3 スキーマ駆動開発 (Schema-Driven Development)
*   **原則:** APIの仕様（スキーマ）を最初に定義し、それを信頼できる唯一の情報源（Single Source of Truth）としてフロントエンドとバックエンドの開発を並行して進めます。
*   **実践:**
    *   **OpenAPI (Swagger) Specification:** API Gatewayで定義するAPIのスキーマをOpenAPI 3.0形式で記述します。
    *   **コード自動生成:** スキーマ定義から、フロントエンドのAPIクライアントコード (TypeScript) と、バックエンドのリクエスト/レスポンスの型定義 (Rust) を自動生成します。これにより、手作業による型の不整合を撲滅します。

---

## 3. 技術仕様

### 3.1 技術スタック

| 領域 | 技術 | 目的 |
| :--- | :--- | :--- |
| **フロントエンド** | React 18 + TypeScript | 最新のコンポーネントベースUI開発 |
| | Vite | 高速なビルドと開発環境 |
| | Tailwind CSS | 効率的なユーティリティファーストのスタイリング |
| | Zustand | シンプルで強力な状態管理 |
| | Chart.js / Recharts | データの可視化、グラフ表示 |
| **PWA関連** | Workbox | Service Workerの管理とオフライン対応 |
| | Web App Manifest | ホーム画面へのインストール対応 |
| **バックエンド** | AWS Lambda (Rust) | サーバーレスでのビジネスロジック実行 |
| **データベース** | Amazon DynamoDB | 高スケーラビリティを持つNoSQLデータベース |
| **API** | Amazon API Gateway | RESTful APIの管理と公開 |
| **インフラ** | Amazon S3 / CloudFront | 静的ファイルのホスティングと高速配信 (CDN) |
| **Infrastructure as Code** | terraform | AWSリソースのコード管理 |
| **CI/CD** | GitHub Actions | 自動ビルド、テスト、デプロイ |
| **認証** | AWS Cognito (匿名認証) | ユーザー登録不要のセキュアな認証 |
| **その他** | OpenAPI, Playwright | スキーマ定義、E2Eテスト |

### 3.2 PWA要件
*   **インストール可能**: ホーム画面への追加（Add to Home Screen）に対応します。
*   **オフライン動作**: Service Workerを利用したキャッシュ戦略により、オフラインでもコア機能が利用可能です。
*   **レスポンシブ**: モバイル、タブレット、デスクトップの各デバイスに最適化されたUIを提供します。
*   **高速**: First Contentful Paint (FCP) を2秒未満に抑え、快適なユーザー体験を実現します。
*   **信頼性**: ネットワークが不安定な状況でも、主要な機能が安定して動作します。

---

## 4. アーキテクチャ設計

### 4.1 システム構成図

```
┌─────────────────┐       ┌──────────────────────────────────────────────────────┐
│   PWA Client    │       │                      AWS Cloud                       │
│  (React + TS)   ├───────┼▶ Amazon CloudFront (CDN) ◀────▶ Amazon S3          │
│ └─ API Client ──┘       │                             (PWA静的ファイルホスティング)│
└─────────────────┘       │                                                      │
         ▲                └──────────────────────────────────────────────────────┘
         │ (Generated Typed API Call)
         ▼
┌──────────────────────────────────────────────────────┐
│                      AWS Cloud                       │
│                                                      │
│ ┌─────────────┐            ┌──────────────────┐            ┌─────────────┐
│ │ OpenAPI     ├─(Generate)─▶│   AWS Lambda     ├─(TDD/DDD)─▶│ Amazon      │
│ │ Schema (API)│            │   (Rust)         │            │ DynamoDB    │
│ │             ├─(Generate)─▶│ (Domain Logic)   │            │             │
│ └─────────────┘            └──────────────────┘            └─────────────┘
│        ▲
│        │ (Implements)
│ ┌────────────────┐
│ │ Amazon         │
│ │ API Gateway    │
│ └────────────────┘
└──────────────────────────────────────────────────────┘
```

### 4.2 開発ワークフロー
1.  **[スキーマ駆動]** 機能要件に基づき、`OpenAPI`スキーマでAPIのエンドポイント、リクエスト、レスポンスを定義します。
2.  **[スキーマ駆動]** スキーマからフロントエンド用の型定義付きAPIクライアントと、バックエンド用のRustの型定義を**自動生成**します。
3.  **[TDD/DDD] (バックエンド)**：
    a. `Rust`でドメインロジックの振る舞いを定義する**テストを先に書きます**。
    b. テストが通るように、ドメインのエンティティやビジネスロジックを実装します。
    c. コードをクリーンにするリファクタリングを行います。
4.  **(フロントエンド)** 自動生成されたAPIクライアントを使い、モックサーバーを立ててUI開発を並行して進めます。
5.  **インテグレーション:** バックエンドのLambda関数をAPI Gatewayに接続し、フロントエンドと結合して動作を検証します。

---

## 5. データベース設計 (Amazon DynamoDB)

### 5.1 設計思想
DDDの概念を反映し、シングルテーブルデザインを採用します。パーティションキー（PK）とソートキー（SK）を組み合わせることで、ドメインモデルのエンティティや集約ルートを効率的に表現し、関連データを一度のクエリで取得できるようにします。

### 5.2 DynamoDB スキーマ

| PK (パーティションキー) | SK (ソートキー) | `type` 属性 | 備考 |
| :--- | :--- | :--- | :--- |
| `USER#<UserID>` | `PROFILE` | `UserProfile` | **ユーザー集約ルート**。ユーザーの基本情報。 |
| `USER#<UserID>` | `TX#<Timestamp>#<TxID>` | `Transaction` | ユーザーに属する**取引エンティティ**。 |
| `USER#<UserID>` | `BUDGET#<BudgetID>` | `Budget` | ユーザーが設定した**予算エンティティ**。 |
| `USER#<UserID>` | `SETTLEMENT#<SettlementID>` | `Settlement` | ユーザーに紐づく**精算エンティティ**（立て替えなど）。 |
| `GROUP#<GroupID>` | `PROFILE` | `GroupProfile` | **グループ集約ルート**。グループの基本情報。 |
| `GROUP#<GroupID>` | `MEMBER#<UserID>` | `GroupMember` | グループに参加している**メンバー**。 |
| `GROUP#<GroupID>` | `TX#<Timestamp>#<TxID>` | `GroupTransaction` | グループに属する**共有取引エンティティ**。 |
| `GROUP#<GroupID>` | `SETTLEMENT#<SettlementID>` | `Settlement` | グループに紐づく**精算エンティティ**。 |

*   **`type`属性の追加:** 各アイテムの種類を明示する属性を追加。これにより、DynamoDB Streamsなどでデータを処理する際に、アイテムの種類を判別しやすくなります。これはDDDのドメインイベントの概念にも通じます。

---

## 6. 機能仕様

### 6.1 取引管理機能
*   **取引登録:** 金額、説明、カテゴリ、取引種別（実支出/立て替え/グループ）、日付などを入力します。よく使う取引はテンプレートとして保存可能です。
*   **取引一覧・検索:** 期間、種別、カテゴリ、金額範囲などで柔軟にフィルタリング・ソートができます。

### 6.2 家計管理機能
*   **月次サマリー:** `Real`（実支出）取引のみを集計し、カテゴリ別の支出グラフや前月比、予算達成度を可視化します。
*   **予算管理:** 月次やカテゴリ別に予算を設定し、使用状況をリアルタイムで追跡。設定した閾値（例：80%）を超えるとアラート通知を行います。
*   **レポート機能:** 月次・年次レポートを生成し、CSVやPDF形式でエクスポートできます。

### 6.3 立て替え精算機能
*   **立て替え登録:** `Flow`（立て替え）取引として記録し、相手と金額を管理します。
*   **精算管理:** 誰にいくら立て替えているか、誰から返済してもらうかを一覧で確認できます。精算が完了したらステータスを更新します。

### 6.4 グループ機能
*   **グループ作成・参加:** ユーザー登録不要でグループを作成し、6桁の参加コードやQRコードでメンバーを招待できます。グループは一定期間（例: 30日）で自動的にアーカイブされます。
*   **グループ取引管理:** グループ内で発生した支出を登録すると、メンバー間でリアルタイムに共有されます。支払い対象者や分割方法（均等、個別設定など）を指定可能です。
*   **最適精算計算:** 債務グラフを利用したアルゴリズムにより、グループ内での送金回数が最小になるような最適な精算プランを自動で計算し提示します。

---

## 7. テスト仕様

### 7.1 テスト戦略
本プロジェクトはTDDを基本とし、テストピラミッドの各層で品質を保証します。

```
     ▲
    / \
   / ▲ \   <-- E2E Tests (Playwright) - 主要なユーザーストーリーを検証
  / / \ \
 / / ▲ \ \  <-- Integration Tests (Rust + Testcontainers/DynamoDB-Local)
/ / / \ \ \     - Lambda関数とDynamoDBの結合を検証
/ / / ▲ \ \ \
───────────
 Unit Tests   <-- Unit Tests (Rust: ドメインロジック, React: コンポーネント)
(大部分を占める)   - 各関数の振る舞いを個別に、高速に検証 (TDDの主戦場)
```

### 7.2 バックエンドのテスト実践 (Rust)
*   **ユニットテスト:** ドメインモデルの純粋なロジック（例: `Settlement.calculate()`）を、DBなどの外部依存なしでテストします。
*   **インテグレーションテスト:** APIハンドラ（Lambda関数）がリクエストを受け取り、`DynamoDB Local`や`Testcontainers`で起動したテスト用DBと正しく連携できるかを検証します。

### 7.3 フロントエンドのテスト実践 (React)
*   **ユニットテスト (Vitest + React Testing Library):** 状態管理ロジック（Zustandストア）や、UIコンポーネントが与えられたpropsに対して正しく描画されるかをテストします。
*   **E2Eテスト (Playwright):** 「ユーザーがログインし、取引を登録し、サマリー画面で支出が増えていることを確認する」といった一連のシナリオをブラウザ上で自動テストします。

---

## 8. セキュリティとプライバシー

### 8.1 データ保護
*   **通信の暗号化:** すべての通信はHTTPSによって保護されます。
*   **認証と認可:** AWS Cognitoによる匿名認証を利用し、ユーザーデータへのアクセスを厳格に分離・管理します。

### 8.2 プライバシーへの配慮
*   **個人情報の最小化:** ユーザー登録を必須とせず、匿名IDで機能を識別することで、収集する個人情報を最小限に留めます。
*   **データ保持ポリシー:** グループデータは作成から30日が経過すると自動的にアーカイブされます。個人データはユーザー自身が管理・削除できます。
